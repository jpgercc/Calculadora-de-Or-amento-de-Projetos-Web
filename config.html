<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuração de Preços - Calculadora de Orçamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .save-indicator {
            transition: all 0.3s ease;
        }
        .save-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }
        .save-indicator.hide {
            opacity: 0;
            transform: translateY(-20px);
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-teal-800">Configuração de Preços</h1>
            <p class="mt-2 text-lg text-stone-600">Altere os valores das variáveis utilizadas na calculadora de orçamento</p>
            <div class="mt-4">
                <a href="inde.html" class="inline-flex items-center px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition">
                    ← Voltar para Calculadora
                </a>
            </div>
        </header>

        <!-- Indicador de salvamento -->
        <div id="saveIndicator" class="save-indicator hide fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50">
            Configurações salvas!
        </div>

        <main class="space-y-8">
            
            <!-- Preços Base dos Projetos -->
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-stone-200">
                <h2 class="text-2xl font-bold text-stone-800 mb-6">Preços Base dos Projetos</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="nonePrice" class="block text-sm font-medium text-stone-700 mb-1">Nenhum/Personalizado (R$)</label>
                        <input type="number" id="nonePrice" min="0" step="50" class="w-full p-3 bg-stone-100 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                    <div>
                        <label for="pagePrice" class="block text-sm font-medium text-stone-700 mb-1">Página Web (R$)</label>
                        <input type="number" id="pagePrice" min="0" step="50" class="w-full p-3 bg-stone-100 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                    <div>
                        <label for="appPrice" class="block text-sm font-medium text-stone-700 mb-1">Aplicação Web (R$)</label>
                        <input type="number" id="appPrice" min="0" step="50" class="w-full p-3 bg-stone-100 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                </div>
            </div>

            <!-- Preços por Componente -->
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-stone-200">
                <h2 class="text-2xl font-bold text-stone-800 mb-6">Preços por Componente</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="backendPrice" class="block text-sm font-medium text-stone-700 mb-1">Back-end (por nível) (R$)</label>
                        <input type="number" id="backendPrice" min="0" step="50" class="w-full p-3 bg-stone-100 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                    <div>
                        <label for="perPagePrice" class="block text-sm font-medium text-stone-700 mb-1">Por Página Adicional (R$)</label>
                        <input type="number" id="perPagePrice" min="0" step="50" class="w-full p-3 bg-stone-100 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                    <div>
                        <label for="complexityPrice" class="block text-sm font-medium text-stone-700 mb-1">Complexidade (por nível) (R$)</label>
                        <input type="number" id="complexityPrice" min="0" step="50" class="w-full p-3 bg-stone-100 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                </div>
            </div>

            <!-- Preços de Segurança -->
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-stone-200">
                <h2 class="text-2xl font-bold text-stone-800 mb-6">Preços de Segurança</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="securitySimplePrice" class="block text-sm font-medium text-stone-700 mb-1">Segurança Simples (R$)</label>
                        <input type="number" id="securitySimplePrice" min="0" step="50" class="w-full p-3 bg-stone-100 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                    <div>
                        <label for="securityProfessionalPrice" class="block text-sm font-medium text-stone-700 mb-1">Segurança Profissional (R$)</label>
                        <input type="number" id="securityProfessionalPrice" min="0" step="50" class="w-full p-3 bg-stone-100 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                </div>
            </div>

            <!-- Recursos Adicionais -->
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-stone-200">
                <h2 class="text-2xl font-bold text-stone-800 mb-6">Recursos Adicionais</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="databasePrice" class="block text-sm font-medium text-stone-700 mb-1">Banco de Dados (R$)</label>
                        <input type="number" id="databasePrice" min="0" step="50" class="w-full p-3 bg-stone-100 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                    <div>
                        <label for="seoPrice" class="block text-sm font-medium text-stone-700 mb-1">SEO Otimizado (R$)</label>
                        <input type="number" id="seoPrice" min="0" step="50" class="w-full p-3 bg-stone-100 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                    <div>
                        <label for="integrationsPrice" class="block text-sm font-medium text-stone-700 mb-1">Integrações (APIs) (R$)</label>
                        <input type="number" id="integrationsPrice" min="0" step="50" class="w-full p-3 bg-stone-100 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                    <div>
                        <label for="copywritingPrice" class="block text-sm font-medium text-stone-700 mb-1">Copywriting (R$)</label>
                        <input type="number" id="copywritingPrice" min="0" step="50" class="w-full p-3 bg-stone-100 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                    <div>
                        <label for="designPrice" class="block text-sm font-medium text-stone-700 mb-1">Design Exclusivo (R$)</label>
                        <input type="number" id="designPrice" min="0" step="50" class="w-full p-3 bg-stone-100 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                    <div>
                        <label for="urgencyPrice" class="block text-sm font-medium text-stone-700 mb-1">Urgência (R$)</label>
                        <input type="number" id="urgencyPrice" min="0" step="50" class="w-full p-3 bg-stone-100 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                </div>
            </div>

            <!-- Manutenção -->
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-stone-200">
                <h2 class="text-2xl font-bold text-stone-800 mb-6">Manutenção</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="maintenancePrice" class="block text-sm font-medium text-stone-700 mb-1">Manutenção Mensal (R$)</label>
                        <input type="number" id="maintenancePrice" min="0" step="50" class="w-full p-3 bg-stone-100 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-stone-200">
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button id="saveBtn" class="px-6 py-3 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition font-medium">
                        Salvar Configurações
                    </button>
                    <button id="resetBtn" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium">
                        Restaurar Padrões
                    </button>
                    <button id="exportBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                        Exportar Configurações
                    </button>
                    <input type="file" id="importInput" accept=".json" style="display: none;">
                    <button id="importBtn" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium">
                        Importar Configurações
                    </button>
                </div>
            </div>

        </main>
    </div>

    <script>
        // Classe para gerenciar configurações de preços
        class PriceManager {
            constructor() {
                this.defaultPrices = {
                    projectType: { none: 0, page: 3500, app: 5000 },
                    backend: 2500,
                    database: 800,
                    security: { Profissional: 1500, Simples: 750 },
                    perPage: 800,
                    complexity: 1200,
                    seo: 1200,
                    integrations: 1000,
                    copywriting: 1500, 
                    design: 2000,
                    urgency: 700,
                    maintenance: 750
                };
                
                this.storageKey = 'calculatorPrices';
                this.lastSavedHash = null;
            }

            // Validar estrutura de preços
            validatePrices(prices) {
                const requiredKeys = ['projectType', 'backend', 'database', 'security', 'perPage', 
                                    'complexity', 'seo', 'integrations', 'copywriting', 'design', 'urgency', 'maintenance'];
                
                for (const key of requiredKeys) {
                    if (!(key in prices)) {
                        throw new Error(`Campo obrigatório ausente: ${key}`);
                    }
                }

                // Validar tipos específicos
                if (!prices.projectType || typeof prices.projectType !== 'object') {
                    throw new Error('projectType deve ser um objeto');
                }

                if (!prices.security || typeof prices.security !== 'object') {
                    throw new Error('security deve ser um objeto');
                }

                // Validar valores numéricos
                const numericFields = ['backend', 'database', 'perPage', 'complexity', 'seo', 
                                     'integrations', 'copywriting', 'design', 'urgency', 'maintenance'];
                
                for (const field of numericFields) {
                    if (typeof prices[field] !== 'number' || prices[field] < 0) {
                        throw new Error(`${field} deve ser um número não negativo`);
                    }
                }

                return true;
            }

            // Obter preços com fallback
            getPrices() {
                try {
                    const savedPrices = localStorage.getItem(this.storageKey);
                    if (savedPrices) {
                        const parsed = JSON.parse(savedPrices);
                        this.validatePrices(parsed);
                        return { ...this.defaultPrices, ...parsed };
                    }
                } catch (error) {
                    console.warn('Erro ao carregar preços salvos, usando padrões:', error);
                    localStorage.removeItem(this.storageKey);
                }
                return this.defaultPrices;
            }

            // Salvar preços com validação
            savePrices(prices) {
                try {
                    this.validatePrices(prices);
                    const pricesJson = JSON.stringify(prices);
                    localStorage.setItem(this.storageKey, pricesJson);
                    this.lastSavedHash = this.hashCode(pricesJson);
                    return true;
                } catch (error) {
                    throw new Error(`Erro ao salvar configurações: ${error.message}`);
                }
            }

            // Verificar se há mudanças não salvas
            hasUnsavedChanges(currentPrices) {
                const currentHash = this.hashCode(JSON.stringify(currentPrices));
                return this.lastSavedHash !== null && this.lastSavedHash !== currentHash;
            }

            // Hash simples para detectar mudanças
            hashCode(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return hash;
            }

            // Resetar para valores padrão
            resetToDefaults() {
                localStorage.removeItem(this.storageKey);
                this.lastSavedHash = null;
                return this.defaultPrices;
            }
        }

        // Instância global do gerenciador de preços
        const priceManager = new PriceManager();

        // Classe para gerenciar a interface
        class ConfigUI {
            constructor() {
                this.elements = {
                    nonePrice: document.getElementById('nonePrice'),
                    pagePrice: document.getElementById('pagePrice'),
                    appPrice: document.getElementById('appPrice'),
                    backendPrice: document.getElementById('backendPrice'),
                    perPagePrice: document.getElementById('perPagePrice'),
                    complexityPrice: document.getElementById('complexityPrice'),
                    securitySimplePrice: document.getElementById('securitySimplePrice'),
                    securityProfessionalPrice: document.getElementById('securityProfessionalPrice'),
                    databasePrice: document.getElementById('databasePrice'),
                    seoPrice: document.getElementById('seoPrice'),
                    integrationsPrice: document.getElementById('integrationsPrice'),
                    copywritingPrice: document.getElementById('copywritingPrice'),
                    designPrice: document.getElementById('designPrice'),
                    urgencyPrice: document.getElementById('urgencyPrice'),
                    maintenancePrice: document.getElementById('maintenancePrice'),
                    saveBtn: document.getElementById('saveBtn'),
                    resetBtn: document.getElementById('resetBtn'),
                    exportBtn: document.getElementById('exportBtn'),
                    importBtn: document.getElementById('importBtn'),
                    importInput: document.getElementById('importInput'),
                    saveIndicator: document.getElementById('saveIndicator')
                };

                this.debounceTimer = null;
                this.autoSaveEnabled = true;
            }

            // Carregar valores na interface
            loadPrices(prices) {
                try {
                    this.elements.nonePrice.value = prices.projectType.none || 0;
                    this.elements.pagePrice.value = prices.projectType.page;
                    this.elements.appPrice.value = prices.projectType.app;
                    this.elements.backendPrice.value = prices.backend;
                    this.elements.perPagePrice.value = prices.perPage;
                    this.elements.complexityPrice.value = prices.complexity;
                    this.elements.securitySimplePrice.value = prices.security.Simples;
                    this.elements.securityProfessionalPrice.value = prices.security.Profissional;
                    this.elements.databasePrice.value = prices.database;
                    this.elements.seoPrice.value = prices.seo;
                    this.elements.integrationsPrice.value = prices.integrations;
                    this.elements.copywritingPrice.value = prices.copywriting;
                    this.elements.designPrice.value = prices.design;
                    this.elements.urgencyPrice.value = prices.urgency;
                    this.elements.maintenancePrice.value = prices.maintenance;

                    // Marcar como salvos
                    priceManager.lastSavedHash = priceManager.hashCode(JSON.stringify(prices));
                } catch (error) {
                    this.showError('Erro ao carregar configurações: ' + error.message);
                }
            }

            // Coletar valores da interface
            collectPrices() {
                const getValue = (element) => {
                    const value = parseInt(element.value) || 0;
                    return Math.max(0, value); // Garantir valores não negativos
                };

                return {
                    projectType: { 
                        none: getValue(this.elements.nonePrice),
                        page: getValue(this.elements.pagePrice), 
                        app: getValue(this.elements.appPrice)
                    },
                    backend: getValue(this.elements.backendPrice),
                    database: getValue(this.elements.databasePrice),
                    security: { 
                        Profissional: getValue(this.elements.securityProfessionalPrice), 
                        Simples: getValue(this.elements.securitySimplePrice)
                    },
                    perPage: getValue(this.elements.perPagePrice),
                    complexity: getValue(this.elements.complexityPrice),
                    seo: getValue(this.elements.seoPrice),
                    integrations: getValue(this.elements.integrationsPrice),
                    copywriting: getValue(this.elements.copywritingPrice),
                    design: getValue(this.elements.designPrice),
                    urgency: getValue(this.elements.urgencyPrice),
                    maintenance: getValue(this.elements.maintenancePrice)
                };
            }

            // Salvar com debounce para auto-save
            debouncedSave() {
                if (!this.autoSaveEnabled) return;

                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    this.savePrices();
                }, 1000); // 1 segundo de delay
            }

            // Salvar configurações
            savePrices() {
                try {
                    const prices = this.collectPrices();
                    priceManager.savePrices(prices);
                    this.showSaveIndicator('Configurações salvas!', 'success');
                } catch (error) {
                    this.showError('Erro ao salvar: ' + error.message);
                }
            }

            // Mostrar indicador de salvamento
            showSaveIndicator(message = 'Configurações salvas!', type = 'success') {
                const indicator = this.elements.saveIndicator;
                indicator.textContent = message;
                
                // Alterar cor baseado no tipo
                indicator.className = `save-indicator show fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 ${
                    type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
                }`;
                
                setTimeout(() => {
                    indicator.classList.remove('show');
                    indicator.classList.add('hide');
                }, 2500);
            }

            // Mostrar erro
            showError(message) {
                this.showSaveIndicator(message, 'error');
                console.error(message);
            }

            // Configurar auto-save
            setupAutoSave() {
                Object.values(this.elements).forEach(element => {
                    if (element.type === 'number') {
                        element.addEventListener('input', () => this.debouncedSave());
                        element.addEventListener('blur', () => this.validateInput(element));
                    }
                });
            }

            // Validar entrada individual
            validateInput(element) {
                const value = parseInt(element.value);
                if (isNaN(value) || value < 0) {
                    element.value = 0;
                    this.showError(`Valor inválido em ${element.previousElementSibling.textContent}. Usando 0.`);
                }
            }
        }

        // Instância global da interface
        const configUI = new ConfigUI();

        // Funções utilitárias
        class ConfigUtils {
            static formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            static generateBackup() {
                const prices = configUI.collectPrices();
                const backup = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    data: prices,
                    checksum: priceManager.hashCode(JSON.stringify(prices))
                };
                return backup;
            }

            static validateBackup(backup) {
                if (!backup || typeof backup !== 'object') {
                    throw new Error('Formato de backup inválido');
                }

                if (!backup.data || !backup.version) {
                    throw new Error('Backup incompleto ou corrompido');
                }

                // Verificar checksum se disponível
                if (backup.checksum) {
                    const currentChecksum = priceManager.hashCode(JSON.stringify(backup.data));
                    if (currentChecksum !== backup.checksum) {
                        throw new Error('Backup corrompido (checksum inválido)');
                    }
                }

                priceManager.validatePrices(backup.data);
                return true;
            }
        }

        // Carregar valores salvos ou padrões
        function loadPrices() {
            const prices = priceManager.getPrices();
            configUI.loadPrices(prices);
        }

        // Restaurar valores padrão
        function resetToDefaults() {
            if (confirm('Tem certeza de que deseja restaurar todos os valores para os padrões? Esta ação não pode ser desfeita.')) {
                try {
                    const defaultPrices = priceManager.resetToDefaults();
                    configUI.loadPrices(defaultPrices);
                    configUI.showSaveIndicator('Configurações restauradas para os padrões!');
                } catch (error) {
                    configUI.showError('Erro ao restaurar padrões: ' + error.message);
                }
            }
        }

        // Exportar configurações
        function exportConfig() {
            try {
                const backup = ConfigUtils.generateBackup();
                const dataStr = JSON.stringify(backup, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                
                const timestamp = new Date().toISOString().split('T')[0];
                link.download = `configuracoes-precos-${timestamp}.json`;
                link.click();
                
                configUI.showSaveIndicator(`Configurações exportadas (${ConfigUtils.formatFileSize(dataBlob.size)})`);
            } catch (error) {
                configUI.showError('Erro ao exportar: ' + error.message);
            }
        }

        // Importar configurações
        function importConfig() {
            configUI.elements.importInput.click();
        }

        // Processar arquivo importado
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 1024 * 1024) { // 1MB limit
                configUI.showError('Arquivo muito grande. Limite: 1MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    // Verificar se é um backup completo ou apenas dados
                    let importedPrices;
                    if (imported.data && imported.version) {
                        // Formato de backup completo
                        ConfigUtils.validateBackup(imported);
                        importedPrices = imported.data;
                    } else {
                        // Formato legado ou dados diretos
                        priceManager.validatePrices(imported);
                        importedPrices = imported;
                    }
                    
                    priceManager.savePrices(importedPrices);
                    configUI.loadPrices(importedPrices);
                    configUI.showSaveIndicator('Configurações importadas com sucesso!');
                    
                } catch (error) {
                    configUI.showError('Erro ao importar: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                configUI.showError('Erro ao ler o arquivo');
            };
            
            reader.readAsText(file);
            
            // Limpar o input para permitir selecionar o mesmo arquivo novamente
            event.target.value = '';
        }

        // Detectar mudanças não salvas antes de sair
        function setupBeforeUnload() {
            window.addEventListener('beforeunload', (e) => {
                const currentPrices = configUI.collectPrices();
                if (priceManager.hasUnsavedChanges(currentPrices)) {
                    e.preventDefault();
                    e.returnValue = 'Você tem alterações não salvas. Deseja sair mesmo assim?';
                }
            });
        }

        // Event listeners
        configUI.elements.saveBtn.addEventListener('click', () => configUI.savePrices());
        configUI.elements.resetBtn.addEventListener('click', resetToDefaults);
        configUI.elements.exportBtn.addEventListener('click', exportConfig);
        configUI.elements.importBtn.addEventListener('click', importConfig);
        configUI.elements.importInput.addEventListener('change', handleFileImport);

        // Inicializar aplicação
        document.addEventListener('DOMContentLoaded', () => {
            loadPrices();
            configUI.setupAutoSave();
            setupBeforeUnload();
            
            // Indicar que a aplicação está pronta
            configUI.showSaveIndicator('Configurações carregadas!');
        });
    </script>

</body>
</html>
