<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Interativa de Orçamento de Projetos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals with Teal Accent -->
    <!-- Application Structure Plan: A two-column layout was chosen for optimal user experience. The left column contains all interactive controls (configurator), allowing users to define project specifications. The right column displays the results in real-time (total estimated value and a cost breakdown chart). This task-oriented structure is intuitive for a calculator, providing immediate feedback and clarifying how each option impacts the final budget without needing to scroll or navigate. -->
    <!-- Visualization & Content Choices: Project variables are converted into interactive elements like sliders and toggles for a more engaging user experience. The primary output is the total cost, displayed prominently. A dynamic donut chart (Chart.js) was chosen to visualize the cost breakdown by category (e.g., Base, Back-end, Add-ons). This goal is to inform and compare, showing the proportion of each component, which is more insightful than a single final number. This structure provides a clear, interactive narrative of the project's cost. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 450px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 450px;
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
                max-height: 350px;
            }
        }
        /* Custom Toggle Switch Styles */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #0d9488;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #0d9488;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #374151;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .info-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background-color: #6b7280;
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 12px;
            line-height: 16px;
            margin-left: 4px;
            cursor: help;
        }
        .loading-indicator {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 1000;
            font-size: 14px;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        /* Otimizações de performance */
        canvas {
            will-change: transform;
        }
        .chart-container {
            contain: layout style paint;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-teal-800">Calculadora de Orçamento de Projetos</h1>
            <p class="mt-2 text-lg text-stone-600">Uma ferramenta interativa para estimar os custos do seu projeto web.</p>
            <div class="mt-4">
                <a href="config.html" class="inline-flex items-center px-4 py-2 bg-stone-600 text-white rounded-lg hover:bg-stone-700 transition text-sm">
                    ⚙️ Configurar Preços
                </a>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
            
            <!-- Indicador de carregamento -->
            <div id="loadingIndicator" class="loading-indicator">
                <span class="pulse">⚡ Calculando...</span>
            </div>
            
            <!-- Coluna de Configuração -->
            <div id="configurator" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-stone-200">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-stone-800">1. Detalhes do Projeto</h2>
                    <p class="text-stone-500 mt-1">Configure as especificações para obter uma estimativa em tempo real. Cada opção selecionada ajustará o valor total ao lado.</p>
                </div>

                <form id="projectForm" class="space-y-6">
                    
                    <div>
                        <label for="projectType" class="block text-sm font-medium text-stone-700 mb-1">
                            Tipo de Projeto
                            <span class="tooltip">
                                <span class="info-icon">?</span>
                                <span class="tooltiptext">Escolha "Nenhum" para projetos personalizados sem custo base, "Página Web" para sites simples, ou "Aplicação Web" para sistemas complexos.</span>
                            </span>
                        </label>
                        <select id="projectType" class="w-full p-3 bg-stone-100 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                            <option value="none">Nenhum (Custo Base Zero)</option>
                            <option value="page">Página Web</option>
                            <option value="app">Aplicação Web</option>
                        </select>
                    </div>

                    <div id="pageTypeWrapper" style="display: none;">
                        <label for="pageType" class="block text-sm font-medium text-stone-700 mb-1">Tipo de Página</label>
                        <select id="pageType" class="w-full p-3 bg-stone-100 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                            <option value="Simples">Simples</option>
                            <option value="Profissional">Profissional</option>
                        </select>
                    </div>

                    <div class="bg-stone-50 p-3 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium text-stone-700">Incluir Segurança</span>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="includeSecurity" id="includeSecurity" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="includeSecurity" class="toggle-label block overflow-hidden h-6 rounded-full bg-stone-300 cursor-pointer"></label>
                            </div>
                        </div>
                        <div>
                            <label for="securityLevel" class="block text-xs text-stone-600">Nível: <span id="securityLevelValue" class="font-bold text-teal-700">1</span></label>
                            <input id="securityLevel" type="range" min="0" max="5" value="1" class="w-full h-1 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-teal-600">
                            <div class="text-xs text-stone-500 mt-1">0 = Básica, 5 = Máxima segurança</div>
                        </div>
                    </div>

                    <div>
                        <label for="backend" class="block text-sm font-medium text-stone-700">Nível do Back-end: <span id="backendValue" class="font-bold text-teal-700">0</span></label>
                        <input id="backend" type="range" min="0" max="3" value="0" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-teal-600">
                        <div class="text-xs text-stone-500 mt-1">0 = Sem back-end, 1 = Básico, 2 = Intermediário, 3 = Avançado</div>
                    </div>

                    <div>
                        <label for="pages" class="block text-sm font-medium text-stone-700">Número de Páginas: <span id="pagesValue" class="font-bold text-teal-700">0</span></label>
                        <input id="pages" type="range" min="0" max="10" value="0" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-teal-600">
                        <div class="text-xs text-stone-500 mt-1">0 = Apenas página principal</div>
                    </div>

                    <div>
                        <label for="complexity" class="block text-sm font-medium text-stone-700">Complexidade (0-5): <span id="complexityValue" class="font-bold text-teal-700">0</span></label>
                        <input id="complexity" type="range" min="0" max="5" value="0" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-teal-600">
                        <div class="text-xs text-stone-500 mt-1">0 = Projeto simples, 5 = Altamente complexo</div>
                    </div>

                    <div class="border-t border-stone-200 pt-6">
                        <h3 class="text-xl font-bold text-stone-800">2. Recursos Adicionais</h3>
                        <div class="space-y-4 mt-4">
                            <div class="bg-stone-50 p-3 rounded-lg">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-stone-700">Banco de Dados</span>
                                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="database" id="database" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                        <label for="database" class="toggle-label block overflow-hidden h-6 rounded-full bg-stone-300 cursor-pointer"></label>
                                    </div>
                                </div>
                                <div>
                                    <label for="databaseLevel" class="block text-xs text-stone-600">Nível: <span id="databaseLevelValue" class="font-bold text-teal-700">1</span></label>
                                    <input id="databaseLevel" type="range" min="0" max="5" value="1" class="w-full h-1 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-teal-600">
                                    <div class="text-xs text-stone-500 mt-1">0 = Nenhum, 1 = Simples, 5 = Complexo</div>
                                </div>
                            </div>
                            
                            <div class="bg-stone-50 p-3 rounded-lg">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-stone-700">SEO Otimizado</span>
                                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="seo" id="seo" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                        <label for="seo" class="toggle-label block overflow-hidden h-6 rounded-full bg-stone-300 cursor-pointer"></label>
                                    </div>
                                </div>
                                <div>
                                    <label for="seoLevel" class="block text-xs text-stone-600">Nível: <span id="seoLevelValue" class="font-bold text-teal-700">1</span></label>
                                    <input id="seoLevel" type="range" min="0" max="5" value="1" class="w-full h-1 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-teal-600">
                                    <div class="text-xs text-stone-500 mt-1">0 = Básico, 5 = SEO Avançado</div>
                                </div>
                            </div>
                            
                            <div class="bg-stone-50 p-3 rounded-lg">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-stone-700">Integrações (APIs)</span>
                                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="integrations" id="integrations" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                        <label for="integrations" class="toggle-label block overflow-hidden h-6 rounded-full bg-stone-300 cursor-pointer"></label>
                                    </div>
                                </div>
                                <div>
                                    <label for="integrationsLevel" class="block text-xs text-stone-600">Quantidade: <span id="integrationsLevelValue" class="font-bold text-teal-700">1</span></label>
                                    <input id="integrationsLevel" type="range" min="0" max="10" value="1" class="w-full h-1 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-teal-600">
                                    <div class="text-xs text-stone-500 mt-1">Número de integrações/APIs</div>
                                </div>
                            </div>
                            
                            <div class="bg-stone-50 p-3 rounded-lg">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-stone-700">Copywriting</span>
                                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="copywriting" id="copywriting" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                        <label for="copywriting" class="toggle-label block overflow-hidden h-6 rounded-full bg-stone-300 cursor-pointer"></label>
                                    </div>
                                </div>
                                <div>
                                    <label for="copywritingLevel" class="block text-xs text-stone-600">Extensão: <span id="copywritingLevelValue" class="font-bold text-teal-700">1</span></label>
                                    <input id="copywritingLevel" type="range" min="0" max="5" value="1" class="w-full h-1 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-teal-600">
                                    <div class="text-xs text-stone-500 mt-1">0 = Mínimo, 5 = Extenso</div>
                                </div>
                            </div>
                            
                            <div class="bg-stone-50 p-3 rounded-lg">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-stone-700">Design Exclusivo</span>
                                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="design" id="design" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                        <label for="design" class="toggle-label block overflow-hidden h-6 rounded-full bg-stone-300 cursor-pointer"></label>
                                    </div>
                                </div>
                                <div>
                                    <label for="designLevel" class="block text-xs text-stone-600">Complexidade: <span id="designLevelValue" class="font-bold text-teal-700">1</span></label>
                                    <input id="designLevel" type="range" min="0" max="5" value="1" class="w-full h-1 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-teal-600">
                                    <div class="text-xs text-stone-500 mt-1">0 = Template, 5 = Design Premium</div>
                                </div>
                            </div>
                            
                            <div class="bg-stone-50 p-3 rounded-lg">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-stone-700">Urgência</span>
                                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="urgency" id="urgency" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                        <label for="urgency" class="toggle-label block overflow-hidden h-6 rounded-full bg-stone-300 cursor-pointer"></label>
                                    </div>
                                </div>
                                <div>
                                    <label for="urgencyLevel" class="block text-xs text-stone-600">Nível: <span id="urgencyLevelValue" class="font-bold text-teal-700">1</span></label>
                                    <input id="urgencyLevel" type="range" min="0" max="3" value="1" class="w-full h-1 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-teal-600">
                                    <div class="text-xs text-stone-500 mt-1">0 = Normal, 3 = Extrema urgência</div>
                                </div>
                            </div>
                            
                            <div class="bg-stone-50 p-3 rounded-lg">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-stone-700">Manutenção Mensal</span>
                                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                        <input type="checkbox" name="maintenance" id="maintenance" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                        <label for="maintenance" class="toggle-label block overflow-hidden h-6 rounded-full bg-stone-300 cursor-pointer"></label>
                                    </div>
                                </div>
                                <div>
                                    <label for="maintenanceLevel" class="block text-xs text-stone-600">Plano: <span id="maintenanceLevelValue" class="font-bold text-teal-700">1</span></label>
                                    <input id="maintenanceLevel" type="range" min="0" max="3" value="1" class="w-full h-1 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-teal-600">
                                    <div class="text-xs text-stone-500 mt-1">0 = Básico, 3 = Premium</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Coluna de Resultados -->
            <div id="results" class="sticky top-8 self-start">
                <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-stone-200">
                    <div class="mb-6 text-center">
                        <h2 class="text-2xl font-bold text-stone-800">Estimativa de Custo</h2>
                        <p class="text-stone-500 mt-1">O valor e a distribuição dos custos são atualizados instantaneamente com base nas suas seleções.</p>
                    </div>
                    <div class="text-center bg-teal-600 text-white py-6 px-4 rounded-xl">
                        <p id="totalValue" class="text-4xl md:text-5xl font-bold">R$ 0,00</p>
                        <p id="maintenanceValue" class="text-lg mt-1">+ R$ 0,00 / mês</p>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-center text-stone-800 mb-4">Distribuição de Custos</h3>
                        <div class="chart-container">
                            <canvas id="costChart"></canvas>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <button id="exportBudgetBtn" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm">
                            📄 Exportar Orçamento
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Classe para gerenciar a calculadora de orçamento
        class BudgetCalculator {
            constructor() {
                this.prices = this.loadPrices();
                this.cache = new Map();
                this.lastCalculation = null;
            }

            // Carregar preços com fallback
            loadPrices() {
                const defaultPrices = {
                    projectType: { none: 0, page: 3500, app: 5000 },
                    backend: 2500,
                    database: 800,
                    security: { Profissional: 1500, Simples: 750 },
                    perPage: 800,
                    complexity: 1200,
                    seo: 1200,
                    integrations: 1000,
                    copywriting: 1500, 
                    design: 2000,
                    urgency: 700,
                    maintenance: 750
                };

                try {
                    const savedPrices = localStorage.getItem('calculatorPrices');
                    if (savedPrices) {
                        const parsed = JSON.parse(savedPrices);
                        return { ...defaultPrices, ...parsed };
                    }
                } catch (error) {
                    console.warn('Erro ao carregar preços, usando padrões:', error);
                }
                return defaultPrices;
            }

            // Calcular custo de segurança com base no tipo de projeto
            calculateSecurityCost(projectType, pageType, securityLevel, includeSecurity) {
                if (!includeSecurity || securityLevel <= 0) return 0;

                let securityType;
                switch (projectType) {
                    case 'page':
                        securityType = pageType;
                        break;
                    case 'app':
                        securityType = 'Profissional';
                        break;
                    default:
                        securityType = 'Simples';
                }

                return securityLevel * (this.prices.security[securityType] || this.prices.security.Simples);
            }

            // Calcular custos com cache
            calculate(projectData) {
                const cacheKey = JSON.stringify(projectData);
                if (this.cache.has(cacheKey)) {
                    return this.cache.get(cacheKey);
                }

                const {
                    projectType, pageType, backend, pages, complexity,
                    includeSecurity, securityLevel,
                    hasDatabase, databaseLevel,
                    hasSeo, seoLevel,
                    hasIntegrations, integrationsLevel,
                    hasCopywriting, copywritingLevel,
                    hasDesign, designLevel,
                    hasUrgency, urgencyLevel,
                    hasMaintenance, maintenanceLevel
                } = projectData;

                // Custo base só é aplicado se não for "none"
                const baseCost = projectType !== 'none' ? this.prices.projectType[projectType] : 0;
                
                // Custos escaláveis
                const backendCost = backend * this.prices.backend;
                const pagesCost = pages > 0 ? pages * this.prices.perPage : 0;
                const complexityCost = complexity * this.prices.complexity;
                
                // Segurança com lógica melhorada
                const securityCost = this.calculateSecurityCost(projectType, pageType, securityLevel, includeSecurity);
                
                // Recursos opcionais
                const databaseCost = hasDatabase ? databaseLevel * this.prices.database : 0;
                const seoCost = hasSeo ? seoLevel * this.prices.seo : 0;
                const integrationsCost = hasIntegrations ? integrationsLevel * this.prices.integrations : 0;
                const urgencyCost = hasUrgency ? urgencyLevel * this.prices.urgency : 0;
                const copywritingCost = hasCopywriting ? copywritingLevel * this.prices.copywriting : 0;
                const designCost = hasDesign ? designLevel * this.prices.design : 0;
                
                const total = baseCost + backendCost + pagesCost + complexityCost + securityCost + 
                             databaseCost + seoCost + integrationsCost + urgencyCost + copywritingCost + designCost;
                
                const maintenanceCost = hasMaintenance ? maintenanceLevel * this.prices.maintenance : 0;

                const result = {
                    total,
                    maintenanceCost,
                    breakdown: {
                        'Custo Base': baseCost,
                        'Back-end': backendCost,
                        'Páginas': pagesCost,
                        'Complexidade': complexityCost,
                        'Segurança': securityCost,
                        'Banco de Dados': databaseCost,
                        'SEO': seoCost,
                        'Integrações': integrationsCost,
                        'Copywriting': copywritingCost,
                        'Design': designCost,
                        'Urgência': urgencyCost
                    }
                };

                // Cache do resultado
                this.cache.set(cacheKey, result);
                this.lastCalculation = result;
                
                return result;
            }

            // Limpar cache quando preços são atualizados
            clearCache() {
                this.cache.clear();
                this.prices = this.loadPrices();
            }

            // Obter resumo do projeto
            getProjectSummary(projectData) {
                const result = this.calculate(projectData);
                const features = [];

                if (projectData.projectType !== 'none') {
                    features.push(`Tipo: ${this.getProjectTypeLabel(projectData.projectType)}`);
                }
                if (projectData.backend > 0) features.push(`Back-end (Nível ${projectData.backend})`);
                if (projectData.pages > 0) features.push(`${projectData.pages} páginas extras`);
                if (projectData.complexity > 0) features.push(`Complexidade (Nível ${projectData.complexity})`);
                if (projectData.includeSecurity) features.push(`Segurança (Nível ${projectData.securityLevel})`);
                if (projectData.hasDatabase) features.push(`Banco de Dados (Nível ${projectData.databaseLevel})`);
                if (projectData.hasSeo) features.push(`SEO (Nível ${projectData.seoLevel})`);
                if (projectData.hasIntegrations) features.push(`Integrações (Nível ${projectData.integrationsLevel})`);
                if (projectData.hasCopywriting) features.push(`Copywriting (Nível ${projectData.copywritingLevel})`);
                if (projectData.hasDesign) features.push(`Design (Nível ${projectData.designLevel})`);
                if (projectData.hasUrgency) features.push(`Urgência (Nível ${projectData.urgencyLevel})`);

                return {
                    total: result.total,
                    maintenance: result.maintenanceCost,
                    features,
                    breakdown: result.breakdown
                };
            }

            getProjectTypeLabel(type) {
                const labels = {
                    'none': 'Personalizado',
                    'page': 'Página Web',
                    'app': 'Aplicação Web'
                };
                return labels[type] || type;
            }
        }

        // Classe para gerenciar a interface da calculadora
        class CalculatorUI {
            constructor(calculator) {
                this.calculator = calculator;
                this.chart = null;
                this.elements = this.initializeElements();
                this.debounceTimer = null;
            }

            initializeElements() {
                return {
                    form: document.getElementById('projectForm'),
                    totalValue: document.getElementById('totalValue'),
                    maintenanceValue: document.getElementById('maintenanceValue'),
                    
                    projectType: document.getElementById('projectType'),
                    pageTypeWrapper: document.getElementById('pageTypeWrapper'),
                    pageType: document.getElementById('pageType'),
                    
                    includeSecurity: document.getElementById('includeSecurity'),
                    securityLevel: document.getElementById('securityLevel'),
                    securityLevelValue: document.getElementById('securityLevelValue'),

                    backend: document.getElementById('backend'),
                    pages: document.getElementById('pages'),
                    complexity: document.getElementById('complexity'),
                    
                    backendValue: document.getElementById('backendValue'),
                    pagesValue: document.getElementById('pagesValue'),
                    complexityValue: document.getElementById('complexityValue'),

                    database: document.getElementById('database'),
                    databaseLevel: document.getElementById('databaseLevel'),
                    databaseLevelValue: document.getElementById('databaseLevelValue'),
                    
                    seo: document.getElementById('seo'),
                    seoLevel: document.getElementById('seoLevel'),
                    seoLevelValue: document.getElementById('seoLevelValue'),
                    
                    integrations: document.getElementById('integrations'),
                    integrationsLevel: document.getElementById('integrationsLevel'),
                    integrationsLevelValue: document.getElementById('integrationsLevelValue'),
                    
                    copywriting: document.getElementById('copywriting'),
                    copywritingLevel: document.getElementById('copywritingLevel'),
                    copywritingLevelValue: document.getElementById('copywritingLevelValue'),
                    
                    design: document.getElementById('design'),
                    designLevel: document.getElementById('designLevel'),
                    designLevelValue: document.getElementById('designLevelValue'),
                    
                    urgency: document.getElementById('urgency'),
                    urgencyLevel: document.getElementById('urgencyLevel'),
                    urgencyLevelValue: document.getElementById('urgencyLevelValue'),
                    
                    maintenance: document.getElementById('maintenance'),
                    maintenanceLevel: document.getElementById('maintenanceLevel'),
                    maintenanceLevelValue: document.getElementById('maintenanceLevelValue')
                };
            }

            initializeChart() {
                const ctx = document.getElementById('costChart').getContext('2d');
                this.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#14532d', '#0f766e', '#0e7490', '#1d4ed8', 
                                '#6d28d9', '#a21caf', '#be185d', '#ea580c', '#dc2626'
                            ],
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            hoverOffset: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        family: 'Inter',
                                        size: 12
                                    },
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const value = this.formatCurrency(context.parsed);
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            animateRotate: true,
                            duration: 800
                        }
                    }
                });
            }

            formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', { 
                    style: 'currency', 
                    currency: 'BRL',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(value);
            }

            collectFormData() {
                return {
                    projectType: this.elements.projectType.value,
                    pageType: this.elements.pageType.value,
                    backend: parseInt(this.elements.backend.value) || 0,
                    pages: parseInt(this.elements.pages.value) || 0,
                    complexity: parseInt(this.elements.complexity.value) || 0,
                    includeSecurity: this.elements.includeSecurity.checked,
                    securityLevel: parseInt(this.elements.securityLevel.value) || 0,
                    hasDatabase: this.elements.database.checked,
                    databaseLevel: parseInt(this.elements.databaseLevel.value) || 0,
                    hasSeo: this.elements.seo.checked,
                    seoLevel: parseInt(this.elements.seoLevel.value) || 0,
                    hasIntegrations: this.elements.integrations.checked,
                    integrationsLevel: parseInt(this.elements.integrationsLevel.value) || 0,
                    hasCopywriting: this.elements.copywriting.checked,
                    copywritingLevel: parseInt(this.elements.copywritingLevel.value) || 0,
                    hasDesign: this.elements.design.checked,
                    designLevel: parseInt(this.elements.designLevel.value) || 0,
                    hasUrgency: this.elements.urgency.checked,
                    urgencyLevel: parseInt(this.elements.urgencyLevel.value) || 0,
                    hasMaintenance: this.elements.maintenance.checked,
                    maintenanceLevel: parseInt(this.elements.maintenanceLevel.value) || 0
                };
            }

            updateValueDisplays(data) {
                this.elements.backendValue.textContent = data.backend;
                this.elements.pagesValue.textContent = data.pages;
                this.elements.complexityValue.textContent = data.complexity;
                this.elements.securityLevelValue.textContent = data.securityLevel;
                this.elements.databaseLevelValue.textContent = data.databaseLevel;
                this.elements.seoLevelValue.textContent = data.seoLevel;
                this.elements.integrationsLevelValue.textContent = data.integrationsLevel;
                this.elements.copywritingLevelValue.textContent = data.copywritingLevel;
                this.elements.designLevelValue.textContent = data.designLevel;
                this.elements.urgencyLevelValue.textContent = data.urgencyLevel;
                this.elements.maintenanceLevelValue.textContent = data.maintenanceLevel;
            }

            updateChart(breakdown) {
                const labels = [];
                const data = [];
                
                for (const [key, value] of Object.entries(breakdown)) {
                    if (value > 0) {
                        labels.push(key);
                        data.push(value);
                    }
                }
                
                this.chart.data.labels = labels;
                this.chart.data.datasets[0].data = data;
                this.chart.update('active');
            }

            debouncedCalculate() {
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    this.calculateAndRender();
                }, 100); // 100ms debounce
            }

            calculateAndRender() {
                try {
                    const projectData = this.collectFormData();
                    const result = this.calculator.calculate(projectData);

                    // Atualizar displays principais
                    this.elements.totalValue.textContent = this.formatCurrency(result.total);
                    this.elements.maintenanceValue.textContent = `+ ${this.formatCurrency(result.maintenanceCost)} / mês`;
                    this.elements.maintenanceValue.style.display = projectData.hasMaintenance ? 'block' : 'none';

                    // Atualizar displays dos valores
                    this.updateValueDisplays(projectData);

                    // Mostrar/ocultar opções de página
                    this.elements.pageTypeWrapper.style.display = projectData.projectType === 'page' ? 'block' : 'none';

                    // Atualizar gráfico
                    this.updateChart(result.breakdown);

                } catch (error) {
                    console.error('Erro no cálculo:', error);
                    this.elements.totalValue.textContent = 'Erro';
                }
            }

            setupEventListeners() {
                // Event listeners com debounce para performance
                this.elements.form.addEventListener('input', () => this.debouncedCalculate());
                this.elements.projectType.addEventListener('change', () => this.calculateAndRender());
                this.elements.pageType.addEventListener('change', () => this.calculateAndRender());

                // Listener para mudanças nos preços
                window.addEventListener('storage', (e) => {
                    if (e.key === 'calculatorPrices') {
                        this.calculator.clearCache();
                        this.calculateAndRender();
                    }
                });

                // Botão de exportar orçamento
                document.getElementById('exportBudgetBtn').addEventListener('click', () => {
                    this.exportBudget();
                });
            }

            exportBudget() {
                try {
                    const projectData = this.collectFormData();
                    const summary = this.calculator.getProjectSummary(projectData);
                    
                    const budgetReport = {
                        data: new Date().toLocaleDateString('pt-BR'),
                        projeto: {
                            tipo: this.calculator.getProjectTypeLabel(projectData.projectType),
                            resumo: summary.features
                        },
                        custos: {
                            total: summary.total,
                            manutencao_mensal: summary.maintenance,
                            detalhamento: Object.entries(summary.breakdown)
                                .filter(([_, value]) => value > 0)
                                .reduce((acc, [key, value]) => {
                                    acc[key] = this.formatCurrency(value);
                                    return acc;
                                }, {})
                        },
                        total_formatado: this.formatCurrency(summary.total),
                        manutencao_formatada: this.formatCurrency(summary.maintenance)
                    };

                    const dataStr = JSON.stringify(budgetReport, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    
                    const timestamp = new Date().toISOString().split('T')[0];
                    link.download = `orcamento-projeto-${timestamp}.json`;
                    link.click();
                    
                    // Também criar uma versão em texto
                    this.exportBudgetAsText(budgetReport);
                    
                } catch (error) {
                    console.error('Erro ao exportar orçamento:', error);
                    alert('Erro ao exportar orçamento. Tente novamente.');
                }
            }

            exportBudgetAsText(budgetReport) {
                const textContent = `
ORÇAMENTO DE PROJETO WEB
========================

Data: ${budgetReport.data}
Tipo de Projeto: ${budgetReport.projeto.tipo}

RECURSOS INCLUSOS:
${budgetReport.projeto.resumo.map(feature => `• ${feature}`).join('\n')}

DETALHAMENTO DE CUSTOS:
${Object.entries(budgetReport.custos.detalhamento)
    .map(([categoria, valor]) => `${categoria}: ${valor}`)
    .join('\n')}

TOTAL DO PROJETO: ${budgetReport.total_formatado}
${budgetReport.custos.manutencao_mensal > 0 ? 
    `MANUTENÇÃO MENSAL: ${budgetReport.manutencao_formatada}` : ''}

---
Orçamento gerado pela Calculadora de Projetos Web
                `.trim();

                const textBlob = new Blob([textContent], { type: 'text/plain; charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(textBlob);
                
                const timestamp = new Date().toISOString().split('T')[0];
                link.download = `orcamento-projeto-${timestamp}.txt`;
                link.click();
            }

            initialize() {
                this.initializeChart();
                this.setupEventListeners();
                this.calculateAndRender();
            }
        }

        // Inicialização da aplicação
        document.addEventListener('DOMContentLoaded', () => {
            const calculator = new BudgetCalculator();
            const ui = new CalculatorUI(calculator);
            ui.initialize();

            // Expor globalmente para debug (opcional)
            window.budgetApp = { calculator, ui };
        });
    </script>

</body>
</html>
